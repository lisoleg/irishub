<template>
  <div class="sp-assets">
    <div class="sp-assets__header sp-component-title">
      <h3>我的NFT卡券</h3>
    </div>
    <div class="sp-assets__main sp-box sp-shadow">
      <div class="sp-assets__main__item" v-for="denom in fullNFTokens" >
        <div class="sp-assets__main__item" v-for="token in denom?.token_ids" >
          <div class="sp-assets__main__denom__name">
              {{token}}({{ denom?.denom_id }}) ({{tokenName(denom?.denom_id, token)}})
          </div>
          <div class="sp-assets__main__denom__balance">
              <img :src="imgUrl(denom?.denom_id, token)" width="80" height="80" /> 
          </div>
         </div>
      </div>
    </div>
  </div>
</template>
<script lang="ts">
import { defineComponent, PropType } from 'vue'
import { str2rgba } from '../../utils/helpers'
import { queryNftOwnerResponse,idCollection } from '../../utils/nft'

var _this:any;
export default defineComponent({
  name: 'SpNFTAssets',
  props: {     
    address: {
      type: String as PropType<string>,
    } 
  },
  data() {
    return {
      imgUrl: function (denomId:string, tokenId:string) {//}: Promise<string> {
        var res = _this.$store.getters['irismod.nft/getNft']({
              params: { denom_id: denomId, token_id:tokenId },
            })?.nft?.uri;
        //console.log(res)
        return res
      },
      tokenName: function (denomId:string, tokenId:string) {//}: Promise<string> {
        var res = _this.$store.getters['irismod.nft/getNft']({
              params: { denom_id: denomId, token_id:tokenId },
            })?.nft?.name;
        //console.log(res)
        return res
      },
    }
  },
  computed: {
    fullNFTokens: function (): idCollection[] {
      if (this.address != '') {
        var res = this.$store.getters['irismod.nft/getOwner']({
              params: {},
              query: { owner: this.address }, 
              })?.owner?.id_collections; 
        for (let idCollection of res){
          for (let tokenId of idCollection?.token_ids){
            this.$store.dispatch('irismod.nft/QueryNft', {
              params: { denom_id: idCollection?.denom_id, token_id: tokenId } 
            })
          }
        }
        return res
      } 
      return []
    },
  },
  methods: {
    
  },
  created() {
    _this=this
  },
  mounted: function (): void {
    if (this.address != '') {
      this.$store.dispatch('irismod.nft/QueryOwner', {
        query: { owner: this.address }
      })
    }
  },

  watch: {
    address: function (newAddr, oldAddr): void {
      if (newAddr != oldAddr && newAddr  != '') {
        this.$store.dispatch('irismod.nft/QueryOwner', {
          query: { owner: newAddr }
        })
      }
    },
  },
})
</script>
